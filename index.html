<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Budget Manon</title>
<meta name="description" content="Gestion comptes avec prévisionnel, revenus et dépenses fixes. PWA locale.">
<style>
body{font-family:Inter,system-ui,-apple-system,"Helvetica Neue",Arial,sans-serif;margin:0;padding:0;background:#f5f6fa;color:#1f2937;}
.wrap{max-width:960px;margin:0 auto;padding:20px}
h1,h2,h3{margin:0;margin-bottom:8px}
.card{padding:20px;border-radius:12px;margin-bottom:15px;box-shadow:0 6px 12px rgba(0,0,0,0.06);transition:all 0.3s}
.card:hover{box-shadow:0 10px 20px rgba(0,0,0,0.08);}
input,select,button{padding:10px;margin:6px 0;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
input[type=number]{width:120px}
button{background:#3b82f6;color:#fff;border:none;cursor:pointer;transition:all 0.2s}
button:hover{background:#2563eb;}
.flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.tx{display:flex;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px}
.tx.income{background:linear-gradient(90deg,rgba(34,197,94,0.06),transparent)}
.tx.expense{background:linear-gradient(90deg,rgba(239,68,68,0.04),transparent)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.small{font-size:13px;color:#6b7280}
.card-input{width:100%;font-weight:600;text-align:right;font-size:18px;border:none;background:transparent;color:#1f2937}
.card-input:focus{outline:none;color:#111827}
/* Couleurs pastel pour les cartes */
#card-courant{background:#a3d5ff;}
#card-livret{background:#b2f7b2;}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Budget Manon</h1>
    <div class="small">Gestion comptes avec prévisionnel</div>
  </div>

  <!-- Cartes comptes -->
  <div class="flex">
    <div class="card" id="card-courant">
      <h3>Compte chèque</h3>
      <label>Solde actuel (€)</label>
      <input type="number" id="balance-courant" class="card-input" step="0.01">
      <div class="small">Prévisionnel fin de mois</div>
      <div id="forecast-courant" class="card-input">0 €</div>
    </div>
    <div class="card" id="card-livret">
      <h3>Livret</h3>
      <label>Solde actuel (€)</label>
      <input type="number" id="balance-livret" class="card-input" step="0.01">
      <div class="small">Prévisionnel fin de mois</div>
      <div id="forecast-livret" class="card-input">0 €</div>
    </div>
  </div>

  <!-- Sections fixes -->
  <div class="card">
    <h3>Revenus fixes</h3>
    <div id="fixed-incomes"></div>
    <button id="add-fixed-income">Ajouter revenu fixe</button>
  </div>
  <div class="card">
    <h3>Dépenses fixes</h3>
    <div id="fixed-expenses"></div>
    <button id="add-fixed-expense">Ajouter dépense fixe</button>
  </div>

  <!-- Prévisions -->
  <div class="card">
    <h3>Prévisions</h3>
    <form id="txForm">
      <div class="flex">
        <select id="accountSelect" required>
          <option value="courant">Compte chèque</option>
          <option value="livret">Livret</option>
        </select>
        <select id="typeSelect">
          <option value="expense">Dépense</option>
          <option value="income">Recette</option>
        </select>
        <input id="label" placeholder="Libellé" required>
        <input id="amount" type="text" inputmode="decimal" placeholder="Montant" required>
        <input id="date" type="date" required>
        <button type="submit">Ajouter</button>
      </div>
    </form>
    <div id="txList"></div>
  </div>

</div>

<script>
// Stockage local
const STORAGE_KEY = 'budget_manon_v3';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || JSON.stringify({
  balances: {courant:0,livret:0},
  transactions: [],
  fixedIncomes: [],
  fixedExpenses: []
}));

// Elements
const balanceCourant = document.getElementById('balance-courant');
const balanceLivret = document.getElementById('balance-livret');
const forecastCourant = document.getElementById('forecast-courant');
const forecastLivret = document.getElementById('forecast-livret');
const txForm = document.getElementById('txForm');
const txList = document.getElementById('txList');
const fixedIncomesEl = document.getElementById('fixed-incomes');
const fixedExpensesEl = document.getElementById('fixed-expenses');

// Helpers
function formatMoney(n){ return Number(n).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// Initialisation des soldes
balanceCourant.value = state.balances.courant;
balanceLivret.value = state.balances.livret;

// Ajouter revenu/dépense fixe
function renderFixed(){
  fixedIncomesEl.innerHTML='';
  state.fixedIncomes.forEach((f,i)=>{
    const div=document.createElement('div');
    div.className='flex';
    div.innerHTML=`<input value="${f.label}" placeholder="Libellé" data-index="${i}" class="card-input">
                   <input type="number" step="0.01" value="${f.amount}" data-index="${i}" class="card-input">`;
    fixedIncomesEl.appendChild(div);
  });
  fixedExpensesEl.innerHTML='';
  state.fixedExpenses.forEach((f,i)=>{
    const div=document.createElement('div');
    div.className='flex';
    div.innerHTML=`<input value="${f.label}" placeholder="Libellé" data-index="${i}" class="card-input">
                   <input type="number" step="0.01" value="${f.amount}" data-index="${i}" class="card-input">`;
    fixedExpensesEl.appendChild(div);
  });
}
document.getElementById('add-fixed-income').addEventListener('click', ()=>{
  state.fixedIncomes.push({label:'Nouveau',amount:0});
  renderFixed(); save(); render();
});
document.getElementById('add-fixed-expense').addEventListener('click', ()=>{
  state.fixedExpenses.push({label:'Nouveau',amount:0});
  renderFixed(); save(); render();
});

// Transactions
function render(){
  txList.innerHTML='';
  let forecast = {courant: Number(balanceCourant.value), livret: Number(balanceLivret.value)};
  state.transactions.forEach(t=>{
    const div=document.createElement('div');
    div.className='tx '+(t.type==='income'?'income':'expense');
    div.innerHTML=`<div>${t.label} (${t.date}) · ${t.account}</div><div>${t.type==='income'?'+':''}${formatMoney(t.amount)}</div>`;
    txList.appendChild(div);
    const dateTx = new Date(t.date);
    const now = new Date();
    if(t.type==='income' && dateTx>=now){ forecast[t.account]+=Number(t.amount);}
    if(t.type==='expense' && dateTx>=now){ forecast[t.account]-=Number(t.amount);}
  });

  // fixe
  state.fixedIncomes.forEach(f=>{ forecast.courant+=Number(f.amount); });
  state.fixedExpenses.forEach(f=>{ forecast.courant-=Number(f.amount); });

  forecastCourant.textContent = formatMoney(forecast.courant);
  forecastLivret.textContent = formatMoney(forecast.livret);

  save();
}
render(); renderFixed();

// Formulaire ajout transaction
txForm.addEventListener('submit', function(e){
  e.preventDefault();
  const acc=document.getElementById('accountSelect').value;
  const type=document.getElementById('typeSelect').value;
  const label=document.getElementById('label').value;
  let amount=parseFloat(document.getElementById('amount').value.replace(',','.'));
  let date=document.getElement