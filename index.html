<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Budget Manon — PWA (photos)</title>
<meta name="description" content="Gestion comptes, prévisionnel, photos de factures (stockées localement)." />
<style>
  :root{--bg:#f5f7fb;--text:#0f172a;--muted:#6b7280;--accent:#3b82f6}
  body{font-family:Inter,system-ui,-apple-system,"Helvetica Neue",Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:16px auto;padding:18px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .card{padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(15,23,42,0.06);background:#fff;flex:1;min-width:240px;transition:transform .25s}
  .card:hover{transform:translateY(-4px)}
  .label{font-size:13px;color:var(--muted);margin-bottom:6px}
  .card-input{width:100%;font-weight:700;text-align:right;font-size:18px;border:none;background:transparent;color:var(--text)}
  .card-input:focus{outline:none}
  /* pastel colors */
  #card-courant{background:linear-gradient(180deg,#cfe9ff,#a3d5ff)}
  #card-livret{background:linear-gradient(180deg,#eaffea,#b2f7b2)}
  form .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=text], input[type=date], select{padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
  input[type=number]{width:120px;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .tx{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:#fff;box-shadow:0 2px 6px rgba(2,6,23,0.04)}
  .tx .meta{display:flex;gap:8px;align-items:center}
  .thumb{width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #e6e9ef}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px;border-radius:8px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal img{max-width:92vw;max-height:92vh;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  @media (max-width:720px){ .flex{flex-direction:column} .card{min-width:unset} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Budget Manon</h1>
        <div class="small">Saisie des dépenses avec photo (stockage local)</div>
      </div>
      <div class="small">Compte chèque &amp; Livret</div>
    </div>

    <!-- Cards -->
    <div class="flex" style="margin-bottom:14px">
      <div class="card" id="card-courant">
        <div class="label">Compte chèque</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Solde actuel (€)</div>
          <input id="balance-courant" type="number" class="card-input" step="0.01" placeholder="0.00" />
        </div>
        <div style="margin-top:12px" class="small">Prévisionnel fin de mois</div>
        <div id="forecast-courant" style="font-weight:700;font-size:18px;margin-top:6px">0 €</div>
      </div>

      <div class="card" id="card-livret">
        <div class="label">Livret</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Solde actuel (€)</div>
          <input id="balance-livret" type="number" class="card-input" step="0.01" placeholder="0.00" />
        </div>
        <div style="margin-top:12px" class="small">Prévisionnel fin de mois</div>
        <div id="forecast-livret" style="font-weight:700;font-size:18px;margin-top:6px">0 €</div>
      </div>
    </div>

    <!-- Fixed sections -->
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin-top:0">Revenus fixes</h3>
      <div id="fixed-incomes"></div>
      <div style="margin-top:10px"><button id="add-fixed-income" class="btn-ghost">Ajouter revenu fixe</button></div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <h3 style="margin-top:0">Dépenses fixes</h3>
      <div id="fixed-expenses"></div>
      <div style="margin-top:10px"><button id="add-fixed-expense" class="btn-ghost">Ajouter dépense fixe</button></div>
    </div>

    <!-- Formulaire prévision + photo -->
    <div class="card">
      <h3 style="margin-top:0">Ajouter transaction / prévision</h3>
      <form id="txForm">
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px">
          <select id="accountSelect" required>
            <option value="courant">Compte chèque</option>
            <option value="livret">Livret</option>
          </select>
          <select id="typeSelect">
            <option value="expense">Dépense</option>
            <option value="income">Recette</option>
          </select>
          <input id="label" type="text" placeholder="Libellé (ex : Courses)" required style="min-width:140px" />
          <input id="amount" type="text" inputmode="decimal" placeholder="Montant (ex: 12.50)" style="width:120px" required />
          <input id="date" type="date" required />
          <!-- file input: allow camera on iPhone -->
          <input id="photo" type="file" accept="image/*" capture="environment" />
          <button type="submit">Ajouter</button>
        </div>
      </form>

      <div style="margin-top:14px">
        <h4 style="margin:0 0 8px 0">Transactions prévues</h4>
        <div id="txList"></div>
      </div>
    </div>

  </div>

  <!-- modal image viewer -->
  <div id="imgModal" class="modal" style="display:none">
    <div onclick="closeModal()" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">
      <img id="modalImg" src="" alt="photo" />
    </div>
  </div>

<script>
/* ========== Storage model = localStorage + IndexedDB for images ========== */
const STORAGE_KEY = 'budget_manon_photos_v1';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || JSON.stringify({
  balances: {courant:0,livret:0},
  transactions: [],       // {id, account, type, label, amount, date, imageId?}
  fixedIncomes: [],       // {label, amount}
  fixedExpenses: []       // {label, amount}
}));

// IndexedDB helper for images
const DB_NAME = 'BudgetManonImages';
const DB_STORE = 'images';
function openDB(){ 
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB_NAME, 1);
    r.onupgradeneeded = ()=> r.result.createObjectStore(DB_STORE);
    r.onsuccess = ()=> res(r.result);
    r.onerror = ()=> rej(r.error);
  });
}
function idbPut(key, blob){
  return openDB().then(db=>{
    return new Promise((res,rej)=>{
      const tx = db.transaction(DB_STORE,'readwrite').objectStore(DB_STORE);
      const req = tx.put(blob, key);
      req.onsuccess = ()=> { db.close(); res(true); };
      req.onerror = ()=> { db.close(); rej(req.error); };
    });
  });
}
function idbGet(key){
  return openDB().then(db=>{
    return new Promise((res,rej)=>{
      const tx = db.transaction(DB_STORE,'readonly').objectStore(DB_STORE);
      const req = tx.get(key);
      req.onsuccess = ()=> { db.close(); res(req.result); };
      req.onerror = ()=> { db.close(); rej(req.error); };
    });
  });
}
function idbDelete(key){
  return openDB().then(db=>{
    return new Promise((res,rej)=>{
      const tx = db.transaction(DB_STORE,'readwrite').objectStore(DB_STORE);
      const req = tx.delete(key);
      req.onsuccess = ()=> { db.close(); res(true); };
      req.onerror = ()=> { db.close(); rej(req.error); };
    });
  });
}

/* ========== DOM elements ========== */
const balanceCourant = document.getElementById('balance-courant');
const balanceLivret = document.getElementById('balance-livret');
const forecastCourant = document.getElementById('forecast-courant');
const forecastLivret = document.getElementById('forecast-livret');
const fixedIncomesEl = document.getElementById('fixed-incomes');
const fixedExpensesEl = document.getElementById('fixed-expenses');
const txForm = document.getElementById('txForm');
const txList = document.getElementById('txList');
const photoInput = document.getElementById('photo');
const imgModal = document.getElementById('imgModal');
const modalImg = document.getElementById('modalImg');

/* ========== Utils ========== */
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function uid(){ return Math.random().toString(36).slice(2,9) + Date.now().toString(36); }
function formatMoney(n){ return Number(n).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); }

/* ========== Image compression (max 800px) ========== */
function compressImageFile(file, maxSize = 800, quality = 0.8){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        if(w > maxSize || h > maxSize){
          if(w > h){ h = Math.round(h * (maxSize / w)); w = maxSize; }
          else { w = Math.round(w * (maxSize / h)); h = maxSize; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          if(!blob) return rej(new Error('Compression failed'));
          res(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = (e) => rej(e);
      img.src = reader.result;
    };
    reader.onerror = (e) => rej(e);
    reader.readAsDataURL(file);
  });
}

/* ========== Render fixed lists ========== */
function renderFixed(){
  fixedIncomesEl.innerHTML = '';
  state.fixedIncomes.forEach((f,i)=>{
    const row = document.createElement('div');
    row.className = 'flex';
    row.style.marginBottom = '8px';
    row.innerHTML = `<input data-i="${i}" class="f-label" value="${f.label}" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                     <input data-i="${i}" type="number" class="f-amount" step="0.01" value="${Number(f.amount)}" style="width:120px;padding:8px;border-radius:8px;border:1px solid #e6e9ef">`;
    fixedIncomesEl.appendChild(row);
  });

  fixedExpensesEl.innerHTML = '';
  state.fixedExpenses.forEach((f,i)=>{
    const row = document.createElement('div');
    row.className = 'flex';
    row.style.marginBottom = '8px';
    row.innerHTML = `<input data-i="${i}" class="f-label-exp" value="${f.label}" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                     <input data-i="${i}" type="number" class="f-amount-exp" step="0.01" value="${Number(f.amount)}" style="width:120px;padding:8px;border-radius:8px;border:1px solid #e6e9ef">`;
    fixedExpensesEl.appendChild(row);
  });
}

/* ========== Render transactions (with thumbnails) ========== */
async function render(){
  txList.innerHTML = '';
  // forecast base on balances
  const forecast = {courant: Number(balanceCourant.value || 0), livret: Number(balanceLivret.value || 0)};
  const now = new Date();

  // include fixed incomes/expenses into forecast (applies to courant only in this simple model)
  state.fixedIncomes.forEach(f => forecast.courant += Number(f.amount || 0));
  state.fixedExpenses.forEach(f => forecast.courant -= Number(f.amount || 0));

  // render transactions (sorted desc)
  const sorted = [...state.transactions].sort((a,b)=> new Date(b.date) - new Date(a.date));
  for(const t of sorted){
    const tx = document.createElement('div');
    tx.className = 'tx';
    // thumbnail if image exists
    let thumbHtml = '';
    if(t.imageId){
      try{
        const blob = await idbGet(t.imageId);
        if(blob){
          const url = URL.createObjectURL(blob);
          thumbHtml = `<img class="thumb" src="${url}" data-imageid="${t.imageId}" />`;
        }
      }catch(e){ console.warn('img load', e); }
    }
    const left = document.createElement('div');
    left.className = 'meta';
    left.style.gap = '12px';
    left.innerHTML = `${thumbHtml}<div><div style="font-weight:600">${t.label}</div><div class="small">${t.account} · ${t.date}</div></div>`;
    const right = document.createElement('div');
    right.innerHTML = `${t.type==='income'?'+':''}${formatMoney(t.amount)}<div style="margin-top:6px"><button class="btn-ghost" data-id="${t.id}" style="font-size:12px">Suppr</button></div>`;
    tx.appendChild(left);
    tx.appendChild(right);
    txList.appendChild(tx);
  }

  // forecast display
  document.getElementById('forecast-courant').textContent = formatMoney(forecast.courant);
  document.getElementById('forecast-livret').textContent  = formatMoney(forecast.livret);

  save();
}

/* ========== Events ========== */
// create fixed entries
document.getElementById('add-fixed-income').addEventListener('click', ()=>{
  state.fixedIncomes.push({label:'Salaire',amount:0});
  renderFixed(); save(); render();
});
document.getElementById('add-fixed-expense').addEventListener('click', ()=>{
  state.fixedExpenses.push({label:'Loyer',amount:0});
  renderFixed(); save(); render();
});

// listen changes on fixed fields (delegation)
fixedIncomesEl.addEventListener('input', (e)=>{
  const target = e.target;
  const idx = Number(target.dataset.i);
  if(target.classList.contains('f-label')){ state.fixedIncomes[idx].label = target.value; }
  if(target.classList.contains('f-amount')){ state.fixedIncomes[idx].amount = Number(target.value || 0); }
  save(); render();
});
fixedExpensesEl.addEventListener('input', (e)=>{
  const target = e.target;
  const idx = Number(target.dataset.i);
  if(target.classList.contains('f-label-exp')){ state.fixedExpenses[idx].label = target.value; }
  if(target.classList.contains('f-amount-exp')){ state.fixedExpenses[idx].amount = Number(target.value || 0); }
  save(); render();
});

// balances editable
balanceCourant.addEventListener('change', ()=>{ state.balances.courant = Number(balanceCourant.value || 0); save(); render(); });
balanceLivret.addEventListener('change',  ()=>{ state.balances.livret  = Number(balanceLivret.value || 0); save(); render(); });

// add transaction (with optional photo)
txForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const acc = document.getElementById('accountSelect').value;
  const type = document.getElementById('typeSelect').value;
  const label = document.getElementById('label').value.trim();
  let amount = parseFloat(document.getElementById('amount').value.replace(',','.'));
  let date = document.getElementById('date').value;
  if(!label || isNaN(amount) || !date){ alert('Libellé, montant et date valides requis'); return; }

  const file = photoInput.files && photoInput.files[0];
  let imageId = null;
  if(file){
    try{
      const compressedBlob = await compressImageFile(file, 800, 0.8); // option1: ~800px
      imageId = uid();
      await idbPut(imageId, compressedBlob);
    }catch(err){
      console.warn('compress error', err);
      alert('Erreur lors du traitement de l\'image');
    }
  }

  const tx = { id: uid(), account: acc, type: type, label: label, amount: Math.round(amount*100)/100, date: date, imageId: imageId };
  state.transactions.push(tx);
  // reset form
  txForm.reset();
  photoInput.value = '';
  document.getElementById('date').valueAsDate = new Date();
  save();
  render();
});

/* delete transaction (delegated) */
txList.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-id]');
  if(btn){
    const id = btn.getAttribute('data-id');
    if(!confirm('Supprimer cette transaction ?')) return;
    const idx = state.transactions.findIndex(t=>t.id===id);
    if(idx>=0){
      const imgId = state.transactions[idx].imageId;
      if(imgId) { try{ await idbDelete(imgId); }catch(err){ console.warn('del image', err); } }
      state.transactions.splice(idx,1);
      save(); render();
    }
  }
});

/* open image modal when clicking thumbnail (delegation) */
txList.addEventListener('click', async (e)=>{
  const img = e.target.closest('img.thumb');
  if(img){
    const imageId = img.dataset.imageid;
    try{
      const blob = await idbGet(imageId);
      if(blob){
        const url = URL.createObjectURL(blob);
        modalImg.src = url;
        imgModal.style.display = 'flex';
      }
    }catch(err){ console.warn(err); }
  }
});
function closeModal(){ imgModal.style.display = 'none'; modalImg.src = ''; }

/* default date today */
document.getElementById('date').valueAsDate = new Date();

/* initial render */
render();
renderFixed();

/* register simple service worker (optional) */
if('serviceWorker' in navigator){
  try{ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }catch(e){}
}
</script>
</body>
</html>